Предложка котов Тимохи
===

# Переменные окружения

Переменная | Обазательно | Тип | По умолчанию | Назначение
--- | --- | --- | --- | ---
`APP_DATABASE_URL` | Нет | Строка | `sqlite:///../data/db.db` |  URL-подключения к БД, который можно использовать с SQLAlchemy
`APP_BOT_TOKEN` | Да | Строка | - | Токен бота
`APP_BOT_ADMIN_ID` | Да | Число или Строка | - | Идентификатор или юзернейм канала в виде `@username`
`APP_CHANNEL_ID` | Да | Число или Строка | - | Идентификатор или юзернейм канала в виде `@username`
`APP_RUN_METHOD` | Да | Строка | - | Способ запуска бота: `pooling` или `webhook`. При использовании webhook бот будет слушать порт `443`
`APP_BOT_PROXY` | Нет | Строка | `None` | Прокси для бота. Например: `socks5h://user:pass@host:port`

# База данных

Базой данных может быть любая SQL СУБД. Для миграций используется `alembic`

## Запуск миграций

Должна быть задана переменная окружения `APP_DATABASE_URL`.

Для миграции в директории `src` выполнить команду:
```bash
alembic upgrade head
```

## Докер

Настоятельно рекомендуется использовать MySQL вместе SQLite, поскольку последний просто не сможет обслужить
число большое число соединений в текущей конфигурации приложения. В MySQL должна быть задана дефолтная
кодировка `utf8mb4` чтобы хранить эмодзи в БД.

В докере приложение может работать как в режиме поллинга, так и в режиме вебхука.
Однако, для вебхука требуется, чтобы перед приложением был настроенный nginx-сервер,
который принимает https-запросы от телеграма, и перенаправляет их в приложение. Само
же приложение слушает локальный порт 443, который может быть переназначен на любой
другой на Host-машине.

Пример `docker-compose.yml` файла для боевого сервера:
```yaml
version: "3.1"

services:
  db:
    image: petrovalexander/mysql-5.7-mb4:latest
    volumes:
      - "./db:/var/lib/mysql"
    env_file:
      - .mysql.env
    restart: always
  bot:
    image: petrovalexander/timoha-bot:latest
    env_file:
      - .bot.env
    restart: always
    links:
      - db
    environment:
      APP_RUN_METHOD: webhook
    ports:
      - "127.0.0.1:7000:443"
```
